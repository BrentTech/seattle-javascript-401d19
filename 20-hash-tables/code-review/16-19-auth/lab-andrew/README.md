# Lab 19 File Management

## Overview

This API is a simple User Database API. It exists so you can create virtual users and securely store their passwords in an secure manner. After a user is created, they can post cats and get cats by their id if they have a valid token, which is obtained by logging in. A user can also post, get and delete songs, which are stored in the aws cloud service. This server-side app is built using express and mongo.
***
## Getting Started

To get started using this application, familiarity with node and npm, as well as git is assumed. It is also assumed that you have a current version of mongodb. Fork/clone this repo to your machine, and do an `npm install`.

Install jest if you do not have it globally installed with `npm i jest`. In the terminal, navigate to the project folder. Open another new tab in the terminal and in that tab run the command `npm run dbon`. To run the tests, in the original terminal tab type `npm run test`.
***
## Modules

### Models:
There are three models in this application. Account is a basic account to be stored in our MongoDB database. It has a create method, which instantiates a new account in our database and takes three arguments: a username, an email and a password. The password is hashed with bcrypt, and stored as this hash in our database. The second function is verifyPassword, which takes a password as an argument, hashes it, and compares it to the stored password hash in the DB. It throws an error if the password does not match otherwise it returns the account. The last method is the createToken method. It creates a random token seed, saves it to the database, and then encrypts it with our secret salt and sends the encrypted token back. The second model is the cat model. This is a mongo schema for what a user with an account might post. It has  options for says, catPic, firstName, lastName, and a link to the account (which is the only required item). This module is not exporting any functions. The third model is the song model. It is a mongo schema for a song that a user might add. It has a title, a link to the resource being stored by aws, a date created, and a link to the account which created it. 

### Routers:
There are three router modules for routing http requests: the account-router.js module, the cat-router.js and the song-router.js. The account router has a POST route to /signup which creates a new user instance in the mongo database. A GET route to /login exists, which will authenticate the request with the basic-auth-middleware, and with success a token will be returned in the response. The client can then use this token to make POST and GET requests on the cat-router routes. The cat-router has a POST route to /cats, and will create a new cat in the DB using the object passed in the request, if the bearer authorization is first succesful. Each user can have only one cat associated with their account. A GET route exists to /cats/:id where the id is the _id of the specific cat in the DB. This route requires the same bearer authorization as the POST route on cats. Any errors that occur in the routes get passed with http-errors to the error middleware. The song-router.js module defines routes to the /songs resource. The /songs route requires the same authorization as the cats route. The POST route to /songs expects a song filepath to be sent and a field with the title. This is then parsed and saved to the aws storage and a link is returned. The GET /songs/:id route retrieves the data saved to the mongo DB from the POST. The DELETE route /songs/:id finds the resource, parses the url, sends a delete request via the aws S3 with the key taken from the url, and finally deletes that resource from the mongo DB.

### Server and Middleware:
All that is exported from the server.js file is server.start and server.stop. There is a logger-middleware which is required in by express in the server. All requests to the API hit this logger which logs the actions in the log files. This then passes to the actual routing functionality. The account router uses basic authentication which is implemented via the basic-auth-middleware to validate the username and password of a given http request. The cat router uses bearer authorization to compare the token passed to the token seed stored on the DB. This is parsed and handled by the bearer-auth-middleware. If any errors occur during routing, including bad or unauthorized requests, they get passed to the error handling middleware (which is also required into express in server.js) which is parsed and handled from the modules exported from error-middleware.js. Tests are performed by the account-router.test and cat-router.test modules which use the account-mock and cat-mock modules to instantiate and imitate the real world RESTful behavior of this API. The a3 middleware acts as an intermediary between http requests and the aws service.
***
## Making Requests to the API

### Account
To make a POST request, the path will be `'__server_address__/signup'`, e.g. if you are running the server on your own machine, the address will be something like: 'http://localhost:3000/signup'. A POST request expects a JSON object in the form of '{"username":"`<name>`","email":"`<email address>`","password":"`<the security of your account is limited by the strength of your password>`"}' and a new user will be created with a unique ID. All three fields are required, and the username and email must be unique. POST requests without a required field will be rejected with a 400 error, and requests duplicating existing names or emails will be rejected with a 409 error. A GET request can be made to `'__server_address__/login'`. Required is the username and password in the authentication header of the http request, in the standard basic authentication format of username:password. Returned from this will be a token to be used for making POST and GET requests on the cat routes.

### Cat
The POST request to this route is `'__server_address__/cats'`. This request will expect a bearer authorization header to be set with a valid token. This also expects an object with properties corresponding to the cat schema. The only required property is account, which must have a value that corresponds to the user's account id. The GET request is very similar, however it does not require an object to be sent. A GET request can be made to `'__server_address__/cats/:id'` where the :id is a mongo _id of a specific cat. 400 errors can be expected for bad requests, 401 errors for invalid tokens, and 404 errors when the queried object is not found.

### Song
The POST request to this route is `'__server_address__/songs'`. All song requests will expect a bearer authorization header to be set with a valid token. This also expects a title header and a file to be sent, corresponding to the local path to that file. The account must have a value that corresponds to the user's account id. The GET request is very similar, however it does not require a file to be sent. A GET request can be made to `'__server_address__/songs/:id'` where the :id is a mongo _id of a specific song. A DELETE request route is `'__server_address__/songs/:id'` also. This will delete the object at this id, both from aws and also mongo db. 400 errors can be expected for bad requests, 401 errors for invalid tokens, and 404 errors when the queried object is not found.
***
## Technology/Credits

Created by Andrew Bloom. This app is being logged with winston and is using superagent and jest for testing server requests. Request/server errors are being managed with http-errors. Using bcrypt for hashing and jsonWebServer for encryption/decryption. Files being parsed and temporarily stored with multer, and Amazon cloud services is handled by the aws-sdk. Server built with express and persistence managed by mongoose/mongodb.
